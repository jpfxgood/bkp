<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>bkp_core.sync_mod API documentation</title>
    <meta name="description" content="module to implement shared functions for the sync tool" />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>


  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>
      
  <ul>
    <li class="mono"><a href="#bkp_core.sync_mod.dryrun">dryrun</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.errors_count">errors_count</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.machine_path">machine_path</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.pending_markers">pending_markers</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.processed_dirs">processed_dirs</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.processed_files">processed_files</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.remote_processed_files">remote_processed_files</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.remote_processed_files_name">remote_processed_files_name</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.verbose">verbose</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.work_queue">work_queue</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.worker_stop">worker_stop</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.worker_thread_pool">worker_thread_pool</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#bkp_core.sync_mod.process_sync">process_sync</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.set_dryrun">set_dryrun</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.set_verbose">set_verbose</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.start_workers">start_workers</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.stop_workers">stop_workers</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.sync_directory">sync_directory</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.synchronize">synchronize</a></li>
    <li class="mono"><a href="#bkp_core.sync_mod.wait_for_workers">wait_for_workers</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#bkp_core.sync_mod.WorkerParams">WorkerParams</a></span>
        
          
  <ul>
    <li class="mono"><a href="#bkp_core.sync_mod.WorkerParams.__init__">__init__</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">bkp_core.sync_mod</span> module</h1>
  <p>module to implement shared functions for the sync tool</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-bkp_core.sync_mod', this);">Show source &equiv;</a></p>
  <div id="source-bkp_core.sync_mod" class="source">
    <pre><code># Copyright 2013-2014 James P Goodwin bkp@jlgoodwin.com
""" module to implement shared functions for the sync tool """
import sys
import os
import re
import traceback
import queue
import threading
import platform
import time
import subprocess
import smtplib
import datetime
import io
import urllib.request, urllib.parse, urllib.error
from bkp_core.fs_mod import fs_get,fs_put,fs_ls,fs_del,fs_stat,fs_test,fs_utime
from bkp_core.sync_conf import save_config,config,get_config
from bkp_core.util import get_contents, put_contents
from bkp_core.logger import start_logger, stop_logger, wait_for_logger, log

dryrun = False
verbose = False
work_queue = queue.Queue()
machine_path = ""
errors_count = 0
worker_thread_pool = []
processed_files = {}
processed_dirs = {}
pending_markers = []
worker_stop = False
remote_processed_files = {}
remote_processed_files_name = os.path.expanduser("~/.sync/.sync.processed")

def set_dryrun( dr ):
    """ set the dryrun flag to true to prevent real actions in s3 """
    global dryrun
    dryrun = dr

def set_verbose( vb ):
    """ set the verbose flag to true to enable extended output """
    global verbose
    verbose = vb

class WorkerParams:
    """ worker params """
    def __init__(self, method, from_path, to_path, mtime = 0.0):
        """ set up the copy from and to paths for the worker """
        self.from_path = from_path
        self.to_path = to_path
        self.method = method
        self.mtime = mtime

def process_sync():
    """ thread body for worker thread, loop processing the queue until killed """
    global errors_count
    start_time = time.time()
    while not worker_stop:
        try:
            # every 5 minutes dump a stack trace if verbose
            if time.time() - start_time > 300:
                start_time = time.time()
            params = work_queue.get(True,1)
            try:
                if not dryrun:
                    if verbose:
                        log( "Starting transfer: %s to %s"%(params.from_path, params.to_path) )
                    if params.method == fs_put:
                        params.method( params.from_path, params.to_path, get_config, verbose)
                        fs_utime( params.to_path, (params.mtime, params.mtime), get_config)
                    else:
                        params.method( params.from_path, params.to_path, get_config )
                        os.utime( params.to_path, (params.mtime, params.mtime))
                if verbose:
                    log( "Transferred: %s to %s"%(params.from_path, params.to_path) )
                work_queue.task_done()
            except:
                tb = traceback.format_exc()
                log( "Failed Transfer: %s to %s error %s"%(params.from_path, params.to_path, tb) )
                errors_count += 1
                work_queue.task_done()
        except queue.Empty:
            continue
        except:
            work_queue.task_done()
            log(traceback.format_exc())
            continue

def start_workers():
    """ start the workers in the pool """
    global worker_thread_pool
    num_threads = int(get_config()["threads"])

    while num_threads:
        t = threading.Thread(target=process_sync)
        t.start()
        worker_thread_pool.append(t)
        num_threads = num_threads - 1

def stop_workers():
    """ stop the workers """
    global worker_stop
    worker_stop = True

def wait_for_workers():
    """ wait for the worker queue to be empty """
    if not work_queue.empty():
        work_queue.join()
    stop_workers()
    for t in worker_thread_pool:
        if t.is_alive():
            t.join()

def sync_directory( path ):
    """ enqueue the files to be synced for a given directory path, apply filters on datetime, pattern, non-hidden files only, recurse visible subdirs """

    # save off remote directory recursive listing
    remote_files = fs_ls(machine_path+path,True, get_config)



    for (dirpath, dirnames, filenames) in os.walk(path):
        if verbose:
            log("Scanning dirpath= %s"%(dirpath))
        # if exclude_dirs is contained in any of the paths then return
        exclude_dir = False
        for e in get_config()["exclude_dirs"]:
            if e and re.search(e,dirpath):
                exclude_dir = True
                break
        if exclude_dir:
            if verbose:
                log("Excluding dirpath= %s because of e= %s"%(dirpath,e))
            continue

        # get rid of hidden directories
        while True:
            deleted = False
            didx = 0
            for d in dirnames:
                if d[0] == ".":
                    if verbose:
                        log("Deleting hidden directory = %s"%(d))
                    del dirnames[didx]
                    deleted = True
                    break
                didx = didx + 1
            if not deleted:
                break

        # stat the sentinel file .sync to avoid sloshing files around
        sync_marker_path = machine_path + os.path.abspath(dirpath)
        sync_marker_node = ".sync."+ platform.node()
        sync_marker = os.path.join( sync_marker_path, sync_marker_node )
        sync_mtime,sync_size = fs_stat(sync_marker,get_config)

        # process files in the directory enqueueing included files for sync
        for f in filenames:
            # if it is a hidden file skip it
            if f[0] == ".":
                if verbose:
                    log("Skipping hidden file = %s"%(f))
                continue

            # if it is excluded file skip it
            if get_config()["exclude_files"] and re.match(get_config()["exclude_files"],f):
                if verbose:
                    log("Excluding file = %s Because of pattern= %s"%(f,get_config()["exclude_files"]))
                continue

            # build the absolute path for the file and it's sync path
            local_path = os.path.join(os.path.abspath(dirpath),f)
            remote_path = machine_path + local_path

            # if the file is in the time range for this sync then queue it for sync
            s = os.lstat(local_path)
            mtime, size = fs_stat(remote_path,get_config)
            processed_files[remote_path] = True

            if s.st_mtime < mtime and (mtime - s.st_mtime) >= 1.0:
                if verbose:
                    log("Enqueuing get for %s,%s timediff %f"%(remote_path,local_path, mtime - s.st_mtime))
                work_queue.put(WorkerParams( fs_get, remote_path, local_path, mtime ))
            elif s.st_mtime > mtime and (s.st_mtime - mtime) >= 1.0:
                if verbose:
                    log("Enqueuing put for %s,%s timediff %f"%(local_path,remote_path,s.st_mtime - mtime))
                work_queue.put(WorkerParams( fs_put, local_path, remote_path, s.st_mtime ))
            else:
                if verbose:
                    log("Not Enqueuing copy work for %s because time is the same or not greater than last sync"%(local_path))
        # drop a marker file on the remote host
        pending_markers.append((sync_marker_path,sync_marker_node))
        processed_dirs[sync_marker_path] = True

    if verbose:
        log("Checking for files only present on the server")
        log(remote_files)

    #loop over remote files and handle any that haven't already been synced
    for line in io.StringIO(remote_files):
        fdate,ftime,size,fpath = re.split("\s+",line,3)
        fpath = fpath.strip()
        if not fpath in processed_files:
            lpath = fpath[len(machine_path):]
            ldir,lnode = os.path.split(lpath)
            fdir,fnode = os.path.split(fpath)
            # if exclude_dirs is contained in any of the paths then return
            exclude_dir = False
            for e in get_config()["exclude_dirs"]:
                if (e and re.search(e,ldir)) or re.match(".*/\..*",ldir):
                    exclude_dir = True
                    break
            if exclude_dir:
                if verbose:
                    log("Excluding dirpath= %s because of e= %s"%(ldir,e))
                continue
            # if it is a hidden file skip it
            if lnode[0] == ".":
                if verbose:
                    log("Skipping hidden file = %s"%(lnode))
                continue

            # if it is excluded file skip it
            if get_config()["exclude_files"] and re.match(get_config()["exclude_files"],lnode):
                if verbose:
                    log("Excluding file = %s Because of pattern= %s"%(lnode,get_config()["exclude_files"]))
                continue

            # if it was processed in the past don't fetch it just mark it as processed
            # it was deleted on the client otherwise enqueue a get
            if not fpath in remote_processed_files:
                if verbose:
                    log("Enqueuing get for %s,%s"%(fpath,lpath))
                mtime, size = fs_stat(fpath,get_config)
                work_queue.put(WorkerParams( fs_get, fpath, lpath, mtime))
            else:
                if verbose:
                    log("Not enqueuing get for %s becase it was deleted on client"%(fpath))
            processed_files[fpath] = True
            if not fdir in processed_dirs:
                processed_dirs[fdir] = True
                pending_markers.append((fdir,".sync."+platform.node()))

    return

def synchronize():
    """ driver to perform syncrhonize """
    global machine_path, errors_count

    try:
        # the sync target a given machine will be target
        machine_path = get_config()["target"]

        # if there is no connection to the target then exit
        if not fs_test( machine_path, verbose, get_config ):
            return 0

        # get the remote processed files so we can check for deletes
        if os.path.exists(remote_processed_files_name):
            for line in open(remote_processed_files_name):
                remote_processed_files[line.strip()] = True

        # start the logger thread
        start_logger()

        # fire up the worker threads
        start_workers()

        # loop over the paths provided and add them to the work queue
        for d in get_config()["dirs"]:
            sync_directory( d )

        # wait for queue to empty
        wait_for_workers()

        # drop all our sync markers after any copies complete
        for sync_marker_path,sync_marker_node in pending_markers:
            put_contents(sync_marker_path,sync_marker_node, "syncrhonized %s"%time.ctime(),dryrun,get_config,verbose)

        # write out the processed files
        if not dryrun:
            processed_out = open(remote_processed_files_name,"w")
            for fpath in processed_files.keys():
                print(fpath, file=processed_out)
            processed_out.close()

        # wait for the logger to finish
        wait_for_logger()

    finally:
        stop_workers()
        stop_logger()

    if errors_count:
        return 1
    else:
        return 0
</code></pre>
  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="bkp_core.sync_mod.dryrun" class="name">var <span class="ident">dryrun</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="bkp_core.sync_mod.errors_count" class="name">var <span class="ident">errors_count</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="bkp_core.sync_mod.machine_path" class="name">var <span class="ident">machine_path</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="bkp_core.sync_mod.pending_markers" class="name">var <span class="ident">pending_markers</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="bkp_core.sync_mod.processed_dirs" class="name">var <span class="ident">processed_dirs</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="bkp_core.sync_mod.processed_files" class="name">var <span class="ident">processed_files</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="bkp_core.sync_mod.remote_processed_files" class="name">var <span class="ident">remote_processed_files</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="bkp_core.sync_mod.remote_processed_files_name" class="name">var <span class="ident">remote_processed_files_name</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="bkp_core.sync_mod.verbose" class="name">var <span class="ident">verbose</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="bkp_core.sync_mod.work_queue" class="name">var <span class="ident">work_queue</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="bkp_core.sync_mod.worker_stop" class="name">var <span class="ident">worker_stop</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="bkp_core.sync_mod.worker_thread_pool" class="name">var <span class="ident">worker_thread_pool</span></p>
      
  
  <div class="source_cont">
</div>

      </div>

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="bkp_core.sync_mod.process_sync">
    <p>def <span class="ident">process_sync</span>(</p><p>)</p>
    </div>
    

    
  
    <div class="desc"><p>thread body for worker thread, loop processing the queue until killed</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-bkp_core.sync_mod.process_sync', this);">Show source &equiv;</a></p>
  <div id="source-bkp_core.sync_mod.process_sync" class="source">
    <pre><code>def process_sync():
    """ thread body for worker thread, loop processing the queue until killed """
    global errors_count
    start_time = time.time()
    while not worker_stop:
        try:
            # every 5 minutes dump a stack trace if verbose
            if time.time() - start_time > 300:
                start_time = time.time()
            params = work_queue.get(True,1)
            try:
                if not dryrun:
                    if verbose:
                        log( "Starting transfer: %s to %s"%(params.from_path, params.to_path) )
                    if params.method == fs_put:
                        params.method( params.from_path, params.to_path, get_config, verbose)
                        fs_utime( params.to_path, (params.mtime, params.mtime), get_config)
                    else:
                        params.method( params.from_path, params.to_path, get_config )
                        os.utime( params.to_path, (params.mtime, params.mtime))
                if verbose:
                    log( "Transferred: %s to %s"%(params.from_path, params.to_path) )
                work_queue.task_done()
            except:
                tb = traceback.format_exc()
                log( "Failed Transfer: %s to %s error %s"%(params.from_path, params.to_path, tb) )
                errors_count += 1
                work_queue.task_done()
        except queue.Empty:
            continue
        except:
            work_queue.task_done()
            log(traceback.format_exc())
            continue
</code></pre>
  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="bkp_core.sync_mod.set_dryrun">
    <p>def <span class="ident">set_dryrun</span>(</p><p>dr)</p>
    </div>
    

    
  
    <div class="desc"><p>set the dryrun flag to true to prevent real actions in s3</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-bkp_core.sync_mod.set_dryrun', this);">Show source &equiv;</a></p>
  <div id="source-bkp_core.sync_mod.set_dryrun" class="source">
    <pre><code>def set_dryrun( dr ):
    """ set the dryrun flag to true to prevent real actions in s3 """
    global dryrun
    dryrun = dr
</code></pre>
  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="bkp_core.sync_mod.set_verbose">
    <p>def <span class="ident">set_verbose</span>(</p><p>vb)</p>
    </div>
    

    
  
    <div class="desc"><p>set the verbose flag to true to enable extended output</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-bkp_core.sync_mod.set_verbose', this);">Show source &equiv;</a></p>
  <div id="source-bkp_core.sync_mod.set_verbose" class="source">
    <pre><code>def set_verbose( vb ):
    """ set the verbose flag to true to enable extended output """
    global verbose
    verbose = vb
</code></pre>
  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="bkp_core.sync_mod.start_workers">
    <p>def <span class="ident">start_workers</span>(</p><p>)</p>
    </div>
    

    
  
    <div class="desc"><p>start the workers in the pool</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-bkp_core.sync_mod.start_workers', this);">Show source &equiv;</a></p>
  <div id="source-bkp_core.sync_mod.start_workers" class="source">
    <pre><code>def start_workers():
    """ start the workers in the pool """
    global worker_thread_pool
    num_threads = int(get_config()["threads"])

    while num_threads:
        t = threading.Thread(target=process_sync)
        t.start()
        worker_thread_pool.append(t)
        num_threads = num_threads - 1
</code></pre>
  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="bkp_core.sync_mod.stop_workers">
    <p>def <span class="ident">stop_workers</span>(</p><p>)</p>
    </div>
    

    
  
    <div class="desc"><p>stop the workers</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-bkp_core.sync_mod.stop_workers', this);">Show source &equiv;</a></p>
  <div id="source-bkp_core.sync_mod.stop_workers" class="source">
    <pre><code>def stop_workers():
    """ stop the workers """
    global worker_stop
    worker_stop = True
</code></pre>
  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="bkp_core.sync_mod.sync_directory">
    <p>def <span class="ident">sync_directory</span>(</p><p>path)</p>
    </div>
    

    
  
    <div class="desc"><p>enqueue the files to be synced for a given directory path, apply filters on datetime, pattern, non-hidden files only, recurse visible subdirs</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-bkp_core.sync_mod.sync_directory', this);">Show source &equiv;</a></p>
  <div id="source-bkp_core.sync_mod.sync_directory" class="source">
    <pre><code>def sync_directory( path ):
    """ enqueue the files to be synced for a given directory path, apply filters on datetime, pattern, non-hidden files only, recurse visible subdirs """

    # save off remote directory recursive listing
    remote_files = fs_ls(machine_path+path,True, get_config)



    for (dirpath, dirnames, filenames) in os.walk(path):
        if verbose:
            log("Scanning dirpath= %s"%(dirpath))
        # if exclude_dirs is contained in any of the paths then return
        exclude_dir = False
        for e in get_config()["exclude_dirs"]:
            if e and re.search(e,dirpath):
                exclude_dir = True
                break
        if exclude_dir:
            if verbose:
                log("Excluding dirpath= %s because of e= %s"%(dirpath,e))
            continue

        # get rid of hidden directories
        while True:
            deleted = False
            didx = 0
            for d in dirnames:
                if d[0] == ".":
                    if verbose:
                        log("Deleting hidden directory = %s"%(d))
                    del dirnames[didx]
                    deleted = True
                    break
                didx = didx + 1
            if not deleted:
                break

        # stat the sentinel file .sync to avoid sloshing files around
        sync_marker_path = machine_path + os.path.abspath(dirpath)
        sync_marker_node = ".sync."+ platform.node()
        sync_marker = os.path.join( sync_marker_path, sync_marker_node )
        sync_mtime,sync_size = fs_stat(sync_marker,get_config)

        # process files in the directory enqueueing included files for sync
        for f in filenames:
            # if it is a hidden file skip it
            if f[0] == ".":
                if verbose:
                    log("Skipping hidden file = %s"%(f))
                continue

            # if it is excluded file skip it
            if get_config()["exclude_files"] and re.match(get_config()["exclude_files"],f):
                if verbose:
                    log("Excluding file = %s Because of pattern= %s"%(f,get_config()["exclude_files"]))
                continue

            # build the absolute path for the file and it's sync path
            local_path = os.path.join(os.path.abspath(dirpath),f)
            remote_path = machine_path + local_path

            # if the file is in the time range for this sync then queue it for sync
            s = os.lstat(local_path)
            mtime, size = fs_stat(remote_path,get_config)
            processed_files[remote_path] = True

            if s.st_mtime < mtime and (mtime - s.st_mtime) >= 1.0:
                if verbose:
                    log("Enqueuing get for %s,%s timediff %f"%(remote_path,local_path, mtime - s.st_mtime))
                work_queue.put(WorkerParams( fs_get, remote_path, local_path, mtime ))
            elif s.st_mtime > mtime and (s.st_mtime - mtime) >= 1.0:
                if verbose:
                    log("Enqueuing put for %s,%s timediff %f"%(local_path,remote_path,s.st_mtime - mtime))
                work_queue.put(WorkerParams( fs_put, local_path, remote_path, s.st_mtime ))
            else:
                if verbose:
                    log("Not Enqueuing copy work for %s because time is the same or not greater than last sync"%(local_path))
        # drop a marker file on the remote host
        pending_markers.append((sync_marker_path,sync_marker_node))
        processed_dirs[sync_marker_path] = True

    if verbose:
        log("Checking for files only present on the server")
        log(remote_files)

    #loop over remote files and handle any that haven't already been synced
    for line in io.StringIO(remote_files):
        fdate,ftime,size,fpath = re.split("\s+",line,3)
        fpath = fpath.strip()
        if not fpath in processed_files:
            lpath = fpath[len(machine_path):]
            ldir,lnode = os.path.split(lpath)
            fdir,fnode = os.path.split(fpath)
            # if exclude_dirs is contained in any of the paths then return
            exclude_dir = False
            for e in get_config()["exclude_dirs"]:
                if (e and re.search(e,ldir)) or re.match(".*/\..*",ldir):
                    exclude_dir = True
                    break
            if exclude_dir:
                if verbose:
                    log("Excluding dirpath= %s because of e= %s"%(ldir,e))
                continue
            # if it is a hidden file skip it
            if lnode[0] == ".":
                if verbose:
                    log("Skipping hidden file = %s"%(lnode))
                continue

            # if it is excluded file skip it
            if get_config()["exclude_files"] and re.match(get_config()["exclude_files"],lnode):
                if verbose:
                    log("Excluding file = %s Because of pattern= %s"%(lnode,get_config()["exclude_files"]))
                continue

            # if it was processed in the past don't fetch it just mark it as processed
            # it was deleted on the client otherwise enqueue a get
            if not fpath in remote_processed_files:
                if verbose:
                    log("Enqueuing get for %s,%s"%(fpath,lpath))
                mtime, size = fs_stat(fpath,get_config)
                work_queue.put(WorkerParams( fs_get, fpath, lpath, mtime))
            else:
                if verbose:
                    log("Not enqueuing get for %s becase it was deleted on client"%(fpath))
            processed_files[fpath] = True
            if not fdir in processed_dirs:
                processed_dirs[fdir] = True
                pending_markers.append((fdir,".sync."+platform.node()))

    return
</code></pre>
  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="bkp_core.sync_mod.synchronize">
    <p>def <span class="ident">synchronize</span>(</p><p>)</p>
    </div>
    

    
  
    <div class="desc"><p>driver to perform syncrhonize</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-bkp_core.sync_mod.synchronize', this);">Show source &equiv;</a></p>
  <div id="source-bkp_core.sync_mod.synchronize" class="source">
    <pre><code>def synchronize():
    """ driver to perform syncrhonize """
    global machine_path, errors_count

    try:
        # the sync target a given machine will be target
        machine_path = get_config()["target"]

        # if there is no connection to the target then exit
        if not fs_test( machine_path, verbose, get_config ):
            return 0

        # get the remote processed files so we can check for deletes
        if os.path.exists(remote_processed_files_name):
            for line in open(remote_processed_files_name):
                remote_processed_files[line.strip()] = True

        # start the logger thread
        start_logger()

        # fire up the worker threads
        start_workers()

        # loop over the paths provided and add them to the work queue
        for d in get_config()["dirs"]:
            sync_directory( d )

        # wait for queue to empty
        wait_for_workers()

        # drop all our sync markers after any copies complete
        for sync_marker_path,sync_marker_node in pending_markers:
            put_contents(sync_marker_path,sync_marker_node, "syncrhonized %s"%time.ctime(),dryrun,get_config,verbose)

        # write out the processed files
        if not dryrun:
            processed_out = open(remote_processed_files_name,"w")
            for fpath in processed_files.keys():
                print(fpath, file=processed_out)
            processed_out.close()

        # wait for the logger to finish
        wait_for_logger()

    finally:
        stop_workers()
        stop_logger()

    if errors_count:
        return 1
    else:
        return 0
</code></pre>
  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="bkp_core.sync_mod.wait_for_workers">
    <p>def <span class="ident">wait_for_workers</span>(</p><p>)</p>
    </div>
    

    
  
    <div class="desc"><p>wait for the worker queue to be empty</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-bkp_core.sync_mod.wait_for_workers', this);">Show source &equiv;</a></p>
  <div id="source-bkp_core.sync_mod.wait_for_workers" class="source">
    <pre><code>def wait_for_workers():
    """ wait for the worker queue to be empty """
    if not work_queue.empty():
        work_queue.join()
    stop_workers()
    for t in worker_thread_pool:
        if t.is_alive():
            t.join()
</code></pre>
  </div>
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="bkp_core.sync_mod.WorkerParams" class="name">class <span class="ident">WorkerParams</span></p>
      
  
    <div class="desc"><p>worker params</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-bkp_core.sync_mod.WorkerParams', this);">Show source &equiv;</a></p>
  <div id="source-bkp_core.sync_mod.WorkerParams" class="source">
    <pre><code>class WorkerParams:
    """ worker params """
    def __init__(self, method, from_path, to_path, mtime = 0.0):
        """ set up the copy from and to paths for the worker """
        self.from_path = from_path
        self.to_path = to_path
        self.method = method
        self.mtime = mtime
</code></pre>
  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#bkp_core.sync_mod.WorkerParams">WorkerParams</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="bkp_core.sync_mod.WorkerParams.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, method, from_path, to_path, mtime=0.0)</p>
    </div>
    

    
  
    <div class="desc"><p>set up the copy from and to paths for the worker</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-bkp_core.sync_mod.WorkerParams.__init__', this);">Show source &equiv;</a></p>
  <div id="source-bkp_core.sync_mod.WorkerParams.__init__" class="source">
    <pre><code>def __init__(self, method, from_path, to_path, mtime = 0.0):
    """ set up the copy from and to paths for the worker """
    self.from_path = from_path
    self.to_path = to_path
    self.method = method
    self.mtime = mtime
</code></pre>
  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="bkp_core.sync_mod.WorkerParams.from_path" class="name">var <span class="ident">from_path</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="bkp_core.sync_mod.WorkerParams.method" class="name">var <span class="ident">method</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="bkp_core.sync_mod.WorkerParams.mtime" class="name">var <span class="ident">mtime</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="bkp_core.sync_mod.WorkerParams.to_path" class="name">var <span class="ident">to_path</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
